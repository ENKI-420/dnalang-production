<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNALang Quantum Circuit Editor</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a0f1f 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(20, 20, 30, 0.9);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #2a2a3a;
        }

        .header h1 {
            font-size: 24px;
            background: linear-gradient(45deg, #00ffcc, #0099ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 200px 1fr 300px;
            gap: 20px;
        }

        .gate-palette {
            background: rgba(20, 20, 30, 0.9);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #2a2a3a;
        }

        .gate-palette h3 {
            margin-bottom: 15px;
            color: #00ffcc;
            font-size: 14px;
        }

        .gate {
            background: linear-gradient(135deg, #2a2a3a, #1a1a2a);
            border: 1px solid #3a3a4a;
            color: #00ffcc;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            cursor: move;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .gate:hover {
            background: linear-gradient(135deg, #3a3a4a, #2a2a3a);
            transform: translateX(5px);
            box-shadow: 0 4px 8px rgba(0, 255, 204, 0.3);
        }

        .circuit-canvas-container {
            background: rgba(15, 15, 25, 0.95);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #2a2a3a;
            position: relative;
            overflow: auto;
        }

        #circuit-canvas {
            border: 2px dashed #2a3a4a;
            border-radius: 5px;
            display: block;
            background: rgba(10, 10, 20, 0.5);
        }

        .properties-panel {
            background: rgba(20, 20, 30, 0.9);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #2a2a3a;
        }

        .properties-panel h3 {
            margin-bottom: 15px;
            color: #0099ff;
            font-size: 14px;
        }

        .property-item {
            margin: 10px 0;
            padding: 10px;
            background: rgba(10, 10, 20, 0.5);
            border-radius: 5px;
            border: 1px solid #1a2a3a;
        }

        .property-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }

        .property-value {
            font-size: 14px;
            color: #00ffcc;
            font-weight: bold;
        }

        .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            background: linear-gradient(135deg, #00ffcc, #0099ff);
            color: #0a0a0a;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 255, 204, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .qasm-output {
            background: rgba(10, 10, 20, 0.9);
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            border: 1px solid #2a3a4a;
            font-family: 'Courier New', monospace;
            color: #00ff88;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }

        .stat-box {
            flex: 1;
            background: rgba(10, 10, 20, 0.5);
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #2a3a4a;
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #888;
        }

        .stat-value {
            font-size: 20px;
            color: #00ffcc;
            font-weight: bold;
            margin-top: 5px;
        }

        select {
            background: rgba(20, 20, 30, 0.9);
            color: #e0e0e0;
            border: 1px solid #2a3a4a;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(10, 10, 20, 0.95);
            padding: 30px;
            border-radius: 10px;
            border: 2px solid #00ffcc;
            display: none;
            z-index: 1000;
        }

        .loading.show {
            display: block;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .loading-text {
            color: #00ffcc;
            animation: pulse 1.5s infinite;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: #00ffcc;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            pointer-events: none;
            display: none;
            z-index: 1000;
            border: 1px solid #00ffcc;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ”¬ DNALang Quantum Circuit Editor</h1>
            <div>
                <select id="backend-select">
                    <option value="ibm_torino">IBM Torino (133q)</option>
                    <option value="ibm_kyoto">IBM Kyoto (127q)</option>
                    <option value="ibm_osaka">IBM Osaka (127q)</option>
                    <option value="aer_simulator">Simulator</option>
                </select>
            </div>
        </div>

        <div class="main-layout">
            <div class="gate-palette">
                <h3>Quantum Gates</h3>
                <div class="gate" draggable="true" data-gate="H">H</div>
                <div class="gate" draggable="true" data-gate="X">X</div>
                <div class="gate" draggable="true" data-gate="Y">Y</div>
                <div class="gate" draggable="true" data-gate="Z">Z</div>
                <div class="gate" draggable="true" data-gate="CNOT">CNOT</div>
                <div class="gate" draggable="true" data-gate="SWAP">SWAP</div>
                <div class="gate" draggable="true" data-gate="RX">RX(Î¸)</div>
                <div class="gate" draggable="true" data-gate="RY">RY(Î¸)</div>
                <div class="gate" draggable="true" data-gate="RZ">RZ(Î¸)</div>
                <div class="gate" draggable="true" data-gate="T">T</div>
                <div class="gate" draggable="true" data-gate="S">S</div>
                <div class="gate" draggable="true" data-gate="TOFFOLI">Toffoli</div>
            </div>

            <div class="circuit-canvas-container">
                <canvas id="circuit-canvas" width="800" height="400"></canvas>

                <div class="controls">
                    <button onclick="clearCircuit()">Clear Circuit</button>
                    <button onclick="addQubit()">Add Qubit</button>
                    <button onclick="removeQubit()">Remove Qubit</button>
                    <button onclick="exportQASM()">Export QASM</button>
                    <button onclick="submitToIBM()">Submit to IBM</button>
                    <button onclick="autoOptimize()">Auto-Optimize</button>
                </div>

                <div class="qasm-output" id="qasm-output">
                    // OpenQASM output will appear here
                </div>
            </div>

            <div class="properties-panel">
                <h3>Circuit Properties</h3>

                <div class="property-item">
                    <div class="property-label">Qubits</div>
                    <div class="property-value" id="qubit-count">5</div>
                </div>

                <div class="property-item">
                    <div class="property-label">Gates</div>
                    <div class="property-value" id="gate-count">0</div>
                </div>

                <div class="property-item">
                    <div class="property-label">Depth</div>
                    <div class="property-value" id="circuit-depth">0</div>
                </div>

                <div class="property-item">
                    <div class="property-label">Two-Qubit Gates</div>
                    <div class="property-value" id="two-qubit-gates">0</div>
                </div>

                <h3 style="margin-top: 20px;">Quantum Metrics</h3>

                <div class="property-item">
                    <div class="property-label">Est. Î¦ (Consciousness)</div>
                    <div class="property-value" id="phi-estimate">0.000</div>
                </div>

                <div class="property-item">
                    <div class="property-label">Est. Î› (Coherence)</div>
                    <div class="property-value" id="lambda-estimate">0.000</div>
                </div>

                <div class="stats">
                    <div class="stat-box">
                        <div class="stat-label">Cost Est.</div>
                        <div class="stat-value" id="cost-estimate">$0.00</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Runtime</div>
                        <div class="stat-value" id="runtime-estimate">0s</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="loading" id="loading">
        <div class="loading-text">Submitting to IBM Quantum...</div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        // Circuit Editor State
        class CircuitEditor {
            constructor() {
                this.canvas = document.getElementById('circuit-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.nQubits = 5;
                this.gates = [];
                this.selectedGate = null;
                this.isDragging = false;
                this.dragGate = null;
                this.gridSize = 60;
                this.qubitSpacing = 60;
                this.leftMargin = 50;
                this.topMargin = 50;

                this.init();
            }

            init() {
                this.setupDragAndDrop();
                this.setupCanvas();
                this.draw();
            }

            setupCanvas() {
                this.canvas.addEventListener('click', (e) => this.handleCanvasClick(e));
                this.canvas.addEventListener('mousemove', (e) => this.handleCanvasMove(e));
                window.addEventListener('resize', () => this.resizeCanvas());
                this.resizeCanvas();
            }

            resizeCanvas() {
                const container = this.canvas.parentElement;
                const width = container.clientWidth - 40;
                this.canvas.width = Math.max(800, width);
                this.draw();
            }

            setupDragAndDrop() {
                const gates = document.querySelectorAll('.gate');
                gates.forEach(gate => {
                    gate.addEventListener('dragstart', (e) => {
                        this.dragGate = e.target.dataset.gate;
                        e.dataTransfer.effectAllowed = 'copy';
                    });
                });

                this.canvas.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'copy';
                });

                this.canvas.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (this.dragGate) {
                        const rect = this.canvas.getBoundingClientRect();
                        const x = e.clientX - rect.left;
                        const y = e.clientY - rect.top;
                        this.addGate(this.dragGate, x, y);
                        this.dragGate = null;
                    }
                });
            }

            addGate(gateType, x, y) {
                // Snap to grid
                const col = Math.round((x - this.leftMargin) / this.gridSize);
                const row = Math.round((y - this.topMargin) / this.qubitSpacing);

                if (row >= 0 && row < this.nQubits && col >= 0) {
                    // Check if position is occupied
                    const exists = this.gates.find(g => g.col === col && g.row === row);
                    if (!exists) {
                        this.gates.push({
                            type: gateType,
                            row: row,
                            col: col,
                            params: gateType.startsWith('R') ? Math.PI / 4 : null
                        });
                        this.draw();
                        this.updateStats();
                        this.generateQASM();
                    }
                }
            }

            handleCanvasClick(e) {
                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                // Check if clicking on a gate to remove it
                const col = Math.round((x - this.leftMargin) / this.gridSize);
                const row = Math.round((y - this.topMargin) / this.qubitSpacing);

                const gateIndex = this.gates.findIndex(g => g.col === col && g.row === row);
                if (gateIndex !== -1) {
                    this.gates.splice(gateIndex, 1);
                    this.draw();
                    this.updateStats();
                    this.generateQASM();
                }
            }

            handleCanvasMove(e) {
                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                const col = Math.round((x - this.leftMargin) / this.gridSize);
                const row = Math.round((y - this.topMargin) / this.qubitSpacing);

                const gate = this.gates.find(g => g.col === col && g.row === row);
                const tooltip = document.getElementById('tooltip');

                if (gate) {
                    tooltip.style.display = 'block';
                    tooltip.style.left = e.clientX + 10 + 'px';
                    tooltip.style.top = e.clientY - 30 + 'px';
                    tooltip.textContent = `${gate.type} gate on qubit ${row}`;
                } else {
                    tooltip.style.display = 'none';
                }
            }

            draw() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                // Draw qubit lines
                this.ctx.strokeStyle = '#2a3a4a';
                this.ctx.lineWidth = 2;
                for (let i = 0; i < this.nQubits; i++) {
                    const y = this.topMargin + i * this.qubitSpacing;
                    this.ctx.beginPath();
                    this.ctx.moveTo(this.leftMargin, y);
                    this.ctx.lineTo(this.canvas.width - 50, y);
                    this.ctx.stroke();

                    // Draw qubit labels
                    this.ctx.fillStyle = '#00ffcc';
                    this.ctx.font = '14px monospace';
                    this.ctx.fillText(`q[${i}]`, 10, y + 5);
                }

                // Draw gates
                this.gates.forEach(gate => {
                    this.drawGate(gate);
                });
            }

            drawGate(gate) {
                const x = this.leftMargin + gate.col * this.gridSize;
                const y = this.topMargin + gate.row * this.qubitSpacing;

                // Gate background
                this.ctx.fillStyle = 'rgba(0, 255, 204, 0.1)';
                this.ctx.strokeStyle = '#00ffcc';
                this.ctx.lineWidth = 2;

                if (gate.type === 'CNOT') {
                    // Draw control dot
                    this.ctx.beginPath();
                    this.ctx.arc(x, y, 8, 0, 2 * Math.PI);
                    this.ctx.fill();
                    this.ctx.stroke();

                    // Draw target (assuming next qubit)
                    if (gate.row < this.nQubits - 1) {
                        const targetY = this.topMargin + (gate.row + 1) * this.qubitSpacing;
                        this.ctx.beginPath();
                        this.ctx.moveTo(x, y);
                        this.ctx.lineTo(x, targetY);
                        this.ctx.stroke();

                        // Draw target circle
                        this.ctx.beginPath();
                        this.ctx.arc(x, targetY, 15, 0, 2 * Math.PI);
                        this.ctx.stroke();

                        // Draw plus
                        this.ctx.beginPath();
                        this.ctx.moveTo(x - 10, targetY);
                        this.ctx.lineTo(x + 10, targetY);
                        this.ctx.moveTo(x, targetY - 10);
                        this.ctx.lineTo(x, targetY + 10);
                        this.ctx.stroke();
                    }
                } else {
                    // Draw single-qubit gate box
                    this.ctx.fillRect(x - 20, y - 20, 40, 40);
                    this.ctx.strokeRect(x - 20, y - 20, 40, 40);

                    // Draw gate label
                    this.ctx.fillStyle = '#00ffcc';
                    this.ctx.font = 'bold 16px monospace';
                    this.ctx.textAlign = 'center';
                    this.ctx.textBaseline = 'middle';
                    this.ctx.fillText(gate.type, x, y);
                }
            }

            updateStats() {
                document.getElementById('qubit-count').textContent = this.nQubits;
                document.getElementById('gate-count').textContent = this.gates.length;

                // Calculate depth
                const maxCol = Math.max(0, ...this.gates.map(g => g.col));
                document.getElementById('circuit-depth').textContent = maxCol + 1;

                // Count two-qubit gates
                const twoQubitGates = this.gates.filter(g =>
                    ['CNOT', 'SWAP', 'TOFFOLI'].includes(g.type)
                ).length;
                document.getElementById('two-qubit-gates').textContent = twoQubitGates;

                // Estimate quantum metrics
                const phi = Math.min(0.987, (this.gates.length * 0.1 + twoQubitGates * 0.2));
                const lambda = 2.176435e-8 * (1 + this.gates.length * 0.1);
                document.getElementById('phi-estimate').textContent = phi.toFixed(3);
                document.getElementById('lambda-estimate').textContent = lambda.toExponential(3);

                // Estimate cost
                const runtime = (maxCol + 1) * this.gates.length * 0.001;
                const cost = runtime * 0.00135;
                document.getElementById('cost-estimate').textContent = `$${cost.toFixed(4)}`;
                document.getElementById('runtime-estimate').textContent = `${runtime.toFixed(1)}s`;
            }

            generateQASM() {
                let qasm = `OPENQASM 2.0;\ninclude "qelib1.inc";\n\n`;
                qasm += `qreg q[${this.nQubits}];\n`;
                qasm += `creg c[${this.nQubits}];\n\n`;

                // Sort gates by column for proper time ordering
                const sortedGates = [...this.gates].sort((a, b) => a.col - b.col);

                sortedGates.forEach(gate => {
                    switch(gate.type) {
                        case 'H':
                            qasm += `h q[${gate.row}];\n`;
                            break;
                        case 'X':
                            qasm += `x q[${gate.row}];\n`;
                            break;
                        case 'Y':
                            qasm += `y q[${gate.row}];\n`;
                            break;
                        case 'Z':
                            qasm += `z q[${gate.row}];\n`;
                            break;
                        case 'T':
                            qasm += `t q[${gate.row}];\n`;
                            break;
                        case 'S':
                            qasm += `s q[${gate.row}];\n`;
                            break;
                        case 'CNOT':
                            if (gate.row < this.nQubits - 1) {
                                qasm += `cx q[${gate.row}], q[${gate.row + 1}];\n`;
                            }
                            break;
                        case 'RX':
                            qasm += `rx(${gate.params || 'pi/4'}) q[${gate.row}];\n`;
                            break;
                        case 'RY':
                            qasm += `ry(${gate.params || 'pi/4'}) q[${gate.row}];\n`;
                            break;
                        case 'RZ':
                            qasm += `rz(${gate.params || 'pi/4'}) q[${gate.row}];\n`;
                            break;
                    }
                });

                qasm += `\n// Measure all qubits\n`;
                for (let i = 0; i < this.nQubits; i++) {
                    qasm += `measure q[${i}] -> c[${i}];\n`;
                }

                document.getElementById('qasm-output').textContent = qasm;
                return qasm;
            }

            clear() {
                this.gates = [];
                this.draw();
                this.updateStats();
                this.generateQASM();
            }

            addQubit() {
                if (this.nQubits < 10) {
                    this.nQubits++;
                    this.draw();
                    this.updateStats();
                    this.generateQASM();
                }
            }

            removeQubit() {
                if (this.nQubits > 2) {
                    this.nQubits--;
                    // Remove gates on the removed qubit
                    this.gates = this.gates.filter(g => g.row < this.nQubits);
                    this.draw();
                    this.updateStats();
                    this.generateQASM();
                }
            }
        }

        // Initialize editor
        const editor = new CircuitEditor();

        // Button handlers
        function clearCircuit() {
            editor.clear();
        }

        function addQubit() {
            editor.addQubit();
        }

        function removeQubit() {
            editor.removeQubit();
        }

        function exportQASM() {
            const qasm = editor.generateQASM();
            const blob = new Blob([qasm], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'circuit.qasm';
            a.click();
            URL.revokeObjectURL(url);
        }

        async function submitToIBM() {
            const loading = document.getElementById('loading');
            loading.classList.add('show');

            const qasm = editor.generateQASM();
            const backend = document.getElementById('backend-select').value;

            try {
                const response = await fetch('http://localhost:8000/quantum/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        organism_id: 'circuit-editor-' + Date.now(),
                        circuit_qasm: qasm,
                        shots: 1024,
                        backend: backend
                    })
                });

                const result = await response.json();

                if (result.job_id) {
                    alert(`Job submitted successfully!\nJob ID: ${result.job_id}\nEstimated cost: $${result.estimated_cost}`);
                } else {
                    alert('Submission failed: ' + (result.detail || 'Unknown error'));
                }
            } catch (error) {
                alert('Error submitting to IBM: ' + error.message);
            } finally {
                loading.classList.remove('show');
            }
        }

        function autoOptimize() {
            // Simple optimization: merge adjacent single-qubit gates
            alert('Auto-optimization feature coming soon!');
        }

        // Initialize with sample circuit
        setTimeout(() => {
            editor.addGate('H', 50, 50);
            editor.addGate('CNOT', 110, 50);
            editor.addGate('H', 170, 110);
        }, 100);
    </script>
</body>
</html>